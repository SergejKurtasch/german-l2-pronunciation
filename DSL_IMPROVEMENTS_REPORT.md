# Отчет по улучшению использования DSL словаря

## Проблема

В статистике большая часть слов извлекается из MFA (68.4%), а не из DSL (30.6%). Необходимо было проанализировать причины и предложить решения для увеличения использования DSL без потери качества.

## Анализ

### Тестирование

Было протестировано 20 случайных предложений из базы данных:
- Всего слов: 98
- DSL использован: 30 слов (30.6%)
- MFA использован: 67 слов (68.4%)
- eSpeak использован: 0 слов (0.0%)
- Не найдено: 1 слово (1.0%)

### Основные находки

1. **Размер словарей:**
   - DSL словарь: 3,249 слов
   - MFA словарь: 152,766 слов
   - **Основная причина**: DSL словарь содержит значительно меньше слов, чем MFA

2. **Логика пропуска DSL:**
   - Текущая логика проверяла наличие removable characters ДО нормализации
   - Это приводило к пропуску слов, которые могли быть успешно нормализованы
   - В тестах не было найдено слов, пропущенных из-за этой проблемы (0 слов)

3. **Проблема с нормализацией:**
   - Старая логика: проверка → пропуск → переход к MFA
   - Новая логика: нормализация → проверка → использование если валидно

## Внесенные изменения

### 1. Улучшенная логика обработки DSL фонем

**Файл:** `modules/g2p_module.py`

**Изменения:**
- Нормализация DSL фонем происходит ПЕРЕД проверкой валидности
- Если нормализованные фонемы валидны (не пустые, не содержат только "~") - используется DSL
- Если нормализация приводит к пустым/невалидным фонемам - переход к следующему источнику
- Убрана дублирующая нормализация для DSL фонем

**Код:**
```python
# Priority 1: Try DSL Lexicon (IPA-Dict-DSL) - best for loanwords
if self.dsl_lexicon:
    dsl_phonemes = self.dsl_lexicon.lookup(token)
    if dsl_phonemes:
        # IMPROVED LOGIC: Normalize FIRST, then check if result is valid
        if HAS_PHONEME_NORMALIZER and get_phoneme_normalizer:
            try:
                normalizer = get_phoneme_normalizer()
                # Normalize DSL phonemes first
                normalized_dsl_phonemes = normalizer.normalize_phoneme_list(dsl_phonemes, source='dictionary')
                
                # Check if normalized result is valid
                if normalized_dsl_phonemes and all(ph.strip() and ph != "~" for ph in normalized_dsl_phonemes):
                    # Use normalized DSL phonemes
                    phonemes = normalized_dsl_phonemes
                    source = 'dsl'
                else:
                    # Normalization resulted in empty/invalid phonemes - skip DSL
                    phonemes = None  # Will try next source
            except Exception as e:
                # Fallback: use DSL phonemes as-is
                phonemes = dsl_phonemes
                source = 'dsl'
```

### 2. Оптимизация нормализации

- DSL фонемы нормализуются один раз (при проверке)
- MFA и eSpeak фонемы нормализуются отдельно
- Избегается двойная нормализация

## Рекомендации для дальнейшего улучшения

### 1. Расширение DSL словаря

**Проблема:** DSL словарь содержит только 3,249 слов, что значительно меньше MFA (152,766 слов).

**Рекомендации:**
- Рассмотреть возможность добавления недостающих слов в DSL словарь
- Использовать автоматическое извлечение фонем из MFA для слов, отсутствующих в DSL
- Создать скрипт для синхронизации DSL словаря с MFA

### 2. Улучшение логики fallback

**Текущая логика:** DSL → MFA → eSpeak

**Рекомендации:**
- Добавить логирование для отслеживания, какие слова не найдены в DSL
- Создать статистику использования каждого источника
- Рассмотреть возможность предварительной загрузки DSL словаря для быстрого доступа

### 3. Качество фонем

**Рекомендации:**
- Проверить качество фонем из DSL vs MFA для одинаковых слов
- Если DSL фонемы более точные - приоритизировать их использование
- Добавить метрики качества для сравнения источников

### 4. Мониторинг

**Рекомендации:**
- Добавить статистику использования источников в логи
- Создать дашборд для мониторинга распределения источников
- Отслеживать изменения в использовании DSL после улучшений

## Ожидаемые результаты

### Немедленные улучшения:
- ✅ Улучшенная логика нормализации DSL фонем
- ✅ Более эффективная обработка (без двойной нормализации)
- ✅ Готовность к использованию DSL слов с removable characters после нормализации

### Долгосрочные улучшения (требуют дополнительной работы):
- Увеличение размера DSL словаря
- Улучшение статистики использования DSL
- Мониторинг качества фонем

## Тестирование

Для проверки изменений можно использовать:
```bash
python test_dsl_fallback.py
python test_dsl_detailed.py
```

Эти скрипты анализируют:
- Текущее использование DSL/MFA/eSpeak
- Слова, которые могут быть использованы из DSL после нормализации
- Детальную статистику по каждому источнику

## Заключение

Основная проблема - небольшой размер DSL словаря (3,249 слов vs 152,766 в MFA). Внесенные изменения улучшают логику обработки DSL фонем, но для значительного увеличения использования DSL необходимо расширение словаря.

Улучшенная логика нормализации позволит использовать больше DSL слов в будущем, когда словарь будет расширен, и обеспечит более точную обработку фонем без потери качества.
